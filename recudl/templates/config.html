{% extends "base.html" %}

{% block title %}Configuration - RecuDL{% endblock %}

{% block content %}
<div x-data="configEditor()" x-init="init()">
    <div class="bg-white dark:bg-gray-800 shadow-lg dark:shadow-gray-900/50 rounded-lg border border-gray-200 dark:border-gray-700 transition-colors duration-200">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
                    <i class="fas fa-cog mr-2 text-primary-600 dark:text-primary-400"></i>Configuration Settings
                </h3>
                <div class="flex space-x-3">
                    <button @click="loadConfig()" 
                            class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 dark:ring-offset-gray-800 focus:ring-primary-500 transition-colors duration-200">
                        <i class="fas fa-sync-alt mr-2"></i>Reload
                    </button>
                    <button @click="saveConfig()" 
                            :disabled="loading"
                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 dark:bg-primary-500 dark:hover:bg-primary-600 focus:outline-none focus:ring-2 focus:ring-offset-2 dark:ring-offset-gray-800 focus:ring-primary-500 disabled:opacity-50 transition-colors duration-200">
                        <i class="fas fa-save mr-2" x-show="!loading"></i>
                        <i class="fas fa-spinner fa-spin mr-2" x-show="loading"></i>
                        <span x-text="loading ? 'Saving...' : 'Save Configuration'"></span>
                    </button>
                </div>
            </div>

            <div class="space-y-8">
                <!-- Headers Section -->
                <div>
                    <h4 class="text-md font-medium text-gray-900 dark:text-white mb-4">
                        <i class="fas fa-key mr-2 text-primary-600 dark:text-primary-400"></i>Authentication Headers
                    </h4>
                    
                    <!-- Easy Cookie Setup -->
                    <div class="bg-gradient-to-r from-indigo-50 via-purple-50 to-pink-50 dark:from-indigo-900/20 dark:via-purple-900/20 dark:to-pink-900/20 border border-purple-200 dark:border-purple-800 rounded-lg p-6 mb-6">
                        <div class="text-center mb-6">
                            <h3 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 dark:from-purple-400 dark:to-pink-400 mb-2">
                                üöÄ One-Click Cookie Setup
                            </h3>
                            <p class="text-sm text-gray-600 dark:text-gray-300">
                                The easiest way to get your authentication - works with any browser!
                            </p>
                        </div>
                        
                        <div class="grid md:grid-cols-3 gap-4">
                            <!-- Step 1 -->
                            <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border-2 border-purple-200 dark:border-purple-700 shadow-md">
                                <div class="flex items-center mb-2">
                                    <span class="bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-full w-7 h-7 flex items-center justify-center text-sm font-bold mr-2 shadow">1</span>
                                    <h4 class="font-semibold text-gray-900 dark:text-white">Save Bookmarklet</h4>
                                </div>
                                <p class="text-xs text-gray-600 dark:text-gray-400 mb-3">
                                    <strong>Drag</strong> this magic button to your bookmarks bar ‚Üë
                                </p>
                                <a href="javascript:(function(){var c=document.cookie;var u=navigator.userAgent;var url='http://127.0.0.1:8080/config?cookies='+encodeURIComponent(c)+'&userAgent='+encodeURIComponent(u);window.location.href=url;})();" 
                                   class="inline-flex items-center px-3 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white text-xs font-bold rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all duration-200 shadow-lg transform hover:scale-105">
                                    <i class="fas fa-cookie-bite mr-2"></i>RecuDL Cookie Grabber
                                </a>
                                <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                                    <i class="fas fa-info-circle mr-1"></i>Can't see bookmarks bar?<br>
                                    Press <kbd class="px-1 py-0.5 text-xs bg-gray-100 dark:bg-gray-700 rounded">Ctrl+Shift+B</kbd>
                                </div>
                            </div>
                            
                            <!-- Step 2 -->
                            <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border-2 border-blue-200 dark:border-blue-700 shadow-md">
                                <div class="flex items-center mb-2">
                                    <span class="bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-full w-7 h-7 flex items-center justify-center text-sm font-bold mr-2 shadow">2</span>
                                    <h4 class="font-semibold text-gray-900 dark:text-white">Login to Recu</h4>
                                </div>
                                <div class="text-xs text-gray-600 dark:text-gray-400 space-y-2">
                                    <p>üìç Navigate to <a href="https://recu.me" target="_blank" class="text-blue-600 dark:text-blue-400 underline font-semibold">recu.me</a></p>
                                    <p>üîë Sign in to your account</p>
                                    <p>‚úÖ Make sure you're logged in</p>
                                </div>
                                <div class="mt-3 p-2 bg-blue-50 dark:bg-blue-900/20 rounded-md">
                                    <p class="text-xs text-blue-700 dark:text-blue-300">
                                        <i class="fas fa-lightbulb mr-1"></i>
                                        <strong>Tip:</strong> Stay on recu.me after login
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Step 3 -->
                            <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border-2 border-green-200 dark:border-green-700 shadow-md">
                                <div class="flex items-center mb-2">
                                    <span class="bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-full w-7 h-7 flex items-center justify-center text-sm font-bold mr-2 shadow">3</span>
                                    <h4 class="font-semibold text-gray-900 dark:text-white">Click & Done!</h4>
                                </div>
                                <div class="text-xs text-gray-600 dark:text-gray-400 space-y-2">
                                    <p>üéØ Click your saved bookmarklet</p>
                                    <p>‚ö° Redirects back to RecuDL</p>
                                    <p>‚ú® Cookies auto-fill instantly!</p>
                                </div>
                                <div class="mt-3 p-2 bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-md">
                                    <p class="text-xs font-semibold text-green-700 dark:text-green-300">
                                        <i class="fas fa-sparkles mr-1"></i>
                                        Remember to click "Save Configuration"
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Troubleshooting -->
                        <div class="mt-4 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-md">
                            <details class="cursor-pointer">
                                <summary class="text-xs font-semibold text-yellow-800 dark:text-yellow-200">
                                    <i class="fas fa-question-circle mr-1"></i>Not working? Click here for help
                                </summary>
                                <div class="mt-2 text-xs text-yellow-700 dark:text-yellow-300 space-y-1">
                                    <p>‚Ä¢ <strong>Bookmarklet not appearing?</strong> Make sure bookmarks bar is visible (Ctrl+Shift+B)</p>
                                    <p>‚Ä¢ <strong>Fields not filling?</strong> Ensure RecuDL is running on http://127.0.0.1:8080</p>
                                    <p>‚Ä¢ <strong>Still issues?</strong> You can manually copy cookies from DevTools (F12 ‚Üí Network tab)</p>
                                </div>
                            </details>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Cookie</label>
                            <textarea x-model="config.header.Cookie" 
                                      class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200" 
                                      rows="3" 
                                      placeholder="session_id=abc123; auth_token=xyz789"></textarea>
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Copy from browser DevTools ‚Üí Network ‚Üí Request Headers</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">User-Agent</label>
                            <textarea x-model="config.header['User-Agent']" 
                                      class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200" 
                                      rows="3" 
                                      placeholder="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"></textarea>
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Copy from browser DevTools ‚Üí Network ‚Üí Request Headers</p>
                        </div>
                    </div>
                </div>

                <!-- Post-Processing Section -->
                <div>
                    <h4 class="text-md font-medium text-gray-900 dark:text-white mb-4">
                        <i class="fas fa-cogs mr-2 text-primary-600 dark:text-primary-400"></i>Post-Processing Options
                    </h4>
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   x-model="config.post_process.remux_to_mp4"
                                   class="h-4 w-4 text-primary-600 dark:text-primary-500 focus:ring-primary-500 border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700">
                            <label class="ml-2 block text-sm text-gray-900 dark:text-white">
                                Remux to MP4
                                <span class="block text-xs text-gray-500 dark:text-gray-400">Convert TS files to MP4 format</span>
                            </label>
                        </div>
                        
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   x-model="config.post_process.generate_thumbnail"
                                   class="h-4 w-4 text-primary-600 dark:text-primary-500 focus:ring-primary-500 border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700">
                            <label class="ml-2 block text-sm text-gray-900 dark:text-white">
                                Generate Thumbnail
                                <span class="block text-xs text-gray-500 dark:text-gray-400">Create preview images</span>
                            </label>
                        </div>
                        
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   x-model="config.post_process.organize_output"
                                   class="h-4 w-4 text-primary-600 dark:text-primary-500 focus:ring-primary-500 border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700">
                            <label class="ml-2 block text-sm text-gray-900 dark:text-white">
                                Organize Output
                                <span class="block text-xs text-gray-500 dark:text-gray-400">Move files to output directory</span>
                            </label>
                        </div>
                        
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   x-model="config.post_process.write_report"
                                   class="h-4 w-4 text-primary-600 dark:text-primary-500 focus:ring-primary-500 border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700">
                            <label class="ml-2 block text-sm text-gray-900 dark:text-white">
                                Write Report
                                <span class="block text-xs text-gray-500 dark:text-gray-400">Generate JSON reports</span>
                            </label>
                        </div>
                        
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   x-model="config.post_process.open_in_explorer"
                                   class="h-4 w-4 text-primary-600 dark:text-primary-500 focus:ring-primary-500 border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700">
                            <label class="ml-2 block text-sm text-gray-900 dark:text-white">
                                Open in Explorer
                                <span class="block text-xs text-gray-500 dark:text-gray-400">Show completed files</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Directory Settings -->
                <div>
                    <h4 class="text-md font-medium text-gray-900 dark:text-white mb-4">
                        <i class="fas fa-folder mr-2 text-primary-600 dark:text-primary-400"></i>Directory Settings
                    </h4>
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Output Directory</label>
                            <input type="text" 
                                   x-model="config.post_process.output_dir"
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200"
                                   placeholder="downloads">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Reports Directory</label>
                            <input type="text" 
                                   x-model="config.post_process.reports_dir"
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200"
                                   placeholder="reports">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Thumbnails Directory</label>
                            <input type="text" 
                                   x-model="config.post_process.thumbnails_dir"
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200"
                                   placeholder="thumbnails">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function configEditor() {
    return {
        config: {
            header: {
                'Cookie': '',
                'User-Agent': ''
            },
            post_process: {
                remux_to_mp4: true,
                generate_thumbnail: true,
                organize_output: true,
                open_in_explorer: false,
                write_report: true,
                output_dir: 'downloads',
                reports_dir: 'reports',
                thumbnails_dir: 'thumbnails'
            }
        },
        loading: false,
        
        async init() {
            // Check URL params first (in case this is from bookmarklet)
            const urlParams = new URLSearchParams(window.location.search);
            const cookies = urlParams.get('cookies');
            const userAgent = urlParams.get('userAgent');
            
            if (cookies && userAgent) {
                console.log('Bookmarklet detected! Filling fields...');
                // Pre-fill with URL params
                this.config.header.Cookie = decodeURIComponent(cookies);
                this.config.header['User-Agent'] = decodeURIComponent(userAgent);
                console.log('Cookie filled:', this.config.header.Cookie);
                console.log('User-Agent filled:', this.config.header['User-Agent']);
                
                // Load existing config but don't overwrite if we have URL params
                await this.loadConfig(true);
                
                showToast('üç™ Cookies auto-filled from bookmarklet! Don\'t forget to save.', 'success');
                
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
            } else {
                // Normal load
                await this.loadConfig(false);
            }
        },
        
        async loadConfig(hasUrlParams = false) {
            try {
                const data = await apiCall('/api/config');
                // Only update if we don't have URL params, or if the fields are empty
                if (!hasUrlParams) {
                    this.config.header = data.header || this.config.header;
                }
                this.config.post_process = data.post_process || this.config.post_process;
            } catch (error) {
                console.error('Failed to load config:', error);
                if (!hasUrlParams) {
                    showToast('Failed to load configuration', 'error');
                }
            }
        },
        
        async saveConfig() {
            this.loading = true;
            try {
                const configToSave = {
                    urls: [''], // Keep empty URLs for compatibility
                    header: this.config.header,
                    post_process: this.config.post_process
                };
                
                await apiCall('/api/config', {
                    method: 'POST',
                    body: JSON.stringify(configToSave)
                });
                
                showToast('Configuration saved successfully!', 'success');
            } catch (error) {
                console.error('Failed to save config:', error);
            } finally {
                this.loading = false;
            }
        }
    }
}
</script>
{% endblock %}
