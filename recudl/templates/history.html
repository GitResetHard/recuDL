{% extends "base.html" %}

{% block title %}History - RecuDL{% endblock %}

{% block content %}
<div x-data="historyViewer()" x-init="init()">
    <div class="bg-white dark:bg-gray-800 shadow-lg dark:shadow-gray-900/50 rounded-lg border border-gray-200 dark:border-gray-700 transition-colors duration-200">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
                    <i class="fas fa-history mr-2 text-primary-600 dark:text-primary-400"></i>Download History
                </h3>
                <div class="flex items-center space-x-4">
                    <!-- Filter -->
                    <select x-model="filter" @change="applyFilter()" 
                            class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200">
                        <option value="all">All Downloads</option>
                        <option value="COMPLETE">Completed</option>
                        <option value="FAILED">Failed</option>
                    </select>
                    
                    <!-- Search -->
                    <div class="relative">
                        <input type="text" 
                               x-model="searchTerm" 
                               @input="applyFilter()"
                               class="pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200"
                               placeholder="Search downloads...">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-gray-400 dark:text-gray-500"></i>
                        </div>
                    </div>
                    
                    <button @click="loadHistory()" 
                            class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors duration-200">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <div x-show="loading" class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-4xl text-gray-400 dark:text-gray-500 mb-4"></i>
                <p class="text-gray-500 dark:text-gray-400">Loading history...</p>
            </div>

            <!-- Empty State -->
            <div x-show="!loading && filteredHistory.length === 0" class="text-center py-8">
                <i class="fas fa-inbox text-4xl text-gray-400 dark:text-gray-500 mb-4"></i>
                <p class="text-gray-500 dark:text-gray-400" x-text="searchTerm || filter !== 'all' ? 'No downloads match your criteria' : 'No download history found'"></p>
            </div>

            <!-- History List -->
            <div x-show="!loading && filteredHistory.length > 0" class="space-y-4">
                <template x-for="entry in filteredHistory" :key="entry.timestamp">
                    <div class="border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 rounded-lg p-4 hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors duration-200">
                        <div class="flex items-start justify-between">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center space-x-3 mb-2">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-file-video text-primary-600 dark:text-primary-400"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-medium text-gray-900 dark:text-white truncate" x-text="entry.filename || 'Unknown'"></p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 truncate" x-text="entry.url"></p>
                                    </div>
                                </div>
                                
                                <!-- Status and Timestamp -->
                                <div class="flex items-center space-x-4 text-xs text-gray-500 dark:text-gray-400">
                                    <span x-text="new Date(entry.timestamp * 1000).toLocaleString()"></span>
                                    <span x-show="entry.last_index !== null">
                                        Last segment: <span x-text="entry.last_index"></span>
                                    </span>
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-3">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium transition-colors duration-200"
                                      :class="{
                                          'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200': entry.status === 'COMPLETE',
                                          'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200': entry.status === 'FAILED',
                                          'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200': entry.status === 'ABORTED',
                                          'bg-gray-100 dark:bg-gray-600 text-gray-800 dark:text-gray-200': !['COMPLETE', 'FAILED', 'ABORTED'].includes(entry.status)
                                      }"
                                      x-text="entry.status">
                                </span>
                                
                                <!-- Actions -->
                                <div class="flex items-center space-x-1">
                                    <button @click="copyUrl(entry.url)" 
                                            class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 p-1 rounded transition-colors duration-200"
                                            title="Copy URL">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    
                                    <button x-show="entry.status === 'FAILED' && entry.last_index" 
                                            @click="retryDownload(entry)"
                                            class="text-blue-400 dark:text-blue-300 hover:text-blue-600 dark:hover:text-blue-200 p-1 rounded transition-colors duration-200"
                                            title="Retry Download">
                                        <i class="fas fa-redo"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error Details -->
                        <div x-show="entry.status === 'FAILED' && entry.error" 
                             class="mt-3 p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-md">
                            <p class="text-sm text-red-700 dark:text-red-300" x-text="entry.error"></p>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Pagination -->
            <div x-show="!loading && filteredHistory.length > 0" class="mt-6 flex items-center justify-between">
                <div class="text-sm text-gray-700 dark:text-gray-300">
                    Showing <span x-text="Math.min((currentPage - 1) * itemsPerPage + 1, filteredHistory.length)"></span> 
                    to <span x-text="Math.min(currentPage * itemsPerPage, filteredHistory.length)"></span> 
                    of <span x-text="filteredHistory.length"></span> results
                </div>
                
                <div class="flex items-center space-x-2" x-show="totalPages > 1">
                    <button @click="currentPage = Math.max(1, currentPage - 1)" 
                            :disabled="currentPage === 1"
                            class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-md text-sm bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200">
                        Previous
                    </button>
                    
                    <span class="px-3 py-1 text-sm text-gray-700 dark:text-gray-300">
                        Page <span x-text="currentPage"></span> of <span x-text="totalPages"></span>
                    </span>
                    
                    <button @click="currentPage = Math.min(totalPages, currentPage + 1)" 
                            :disabled="currentPage === totalPages"
                            class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-md text-sm bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200">
                        Next
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function historyViewer() {
    return {
        history: [],
        filteredHistory: [],
        loading: false,
        filter: 'all',
        searchTerm: '',
        currentPage: 1,
        itemsPerPage: 20,
        
        get totalPages() {
            return Math.ceil(this.filteredHistory.length / this.itemsPerPage);
        },
        
        async init() {
            await this.loadHistory();
        },
        
        async loadHistory() {
            this.loading = true;
            try {
                this.history = await apiCall('/api/history');
                this.applyFilter();
            } catch (error) {
                console.error('Failed to load history:', error);
                showToast('Failed to load download history', 'error');
            } finally {
                this.loading = false;
            }
        },
        
        applyFilter() {
            let filtered = [...this.history];
            
            // Apply status filter
            if (this.filter !== 'all') {
                filtered = filtered.filter(entry => entry.status === this.filter);
            }
            
            // Apply search filter
            if (this.searchTerm.trim()) {
                const term = this.searchTerm.toLowerCase();
                filtered = filtered.filter(entry => 
                    (entry.filename && entry.filename.toLowerCase().includes(term)) ||
                    (entry.url && entry.url.toLowerCase().includes(term))
                );
            }
            
            this.filteredHistory = filtered;
            this.currentPage = 1; // Reset to first page
        },
        
        copyUrl(url) {
            navigator.clipboard.writeText(url).then(() => {
                showToast('URL copied to clipboard', 'success');
            }).catch(() => {
                showToast('Failed to copy URL', 'error');
            });
        },
        
        async retryDownload(entry) {
            try {
                await apiCall('/api/downloads', {
                    method: 'POST',
                    body: JSON.stringify({
                        urls: [entry.url],
                        mode: 'parallel'
                    })
                });
                showToast('Download restarted', 'success');
            } catch (error) {
                console.error('Failed to retry download:', error);
            }
        }
    }
}
</script>
{% endblock %}
